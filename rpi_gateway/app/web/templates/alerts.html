{% extends "base.html" %}
{% block title %}Alerts{% endblock %}
{% block content %}
<style>
    .alerts-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .alerts-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .alert-stats {
        display: flex;
        gap: 15px;
    }

    .stat-card {
        padding: 10px 20px;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        min-width: 120px;
        text-align: center;
    }

    .stat-card .count {
        font-size: 1.5em;
        font-weight: bold;
    }

    .stat-card.critical {
        border-left: 4px solid #e74c3c;
        color: #e74c3c;
    }

    .stat-card.warning {
        border-left: 4px solid #f39c12;
        color: #f39c12;
    }

    .stat-card.active {
        border-left: 4px solid #3498db;
        color: #3498db;
    }

    .section-title {
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 1.2em;
        color: #555;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
    }

    .alerts-table {
        width: 100%;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .alerts-table thead {
        background: #f8f9fa;
        color: #555;
        border-bottom: 2px solid #e9ecef;
    }

    .alerts-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85em;
    }

    .alerts-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
    }

    .alerts-table tbody tr:last-child td {
        border-bottom: none;
    }

    .badge {
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: bold;
        text-transform: uppercase;
        display: inline-block;
    }

    .badge-critical {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-error {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-info {
        background: #dbeafe;
        color: #1e40af;
    }

    .btn-ack {
        background: #e0e7ff;
        color: #3730a3;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85em;
        transition: all 0.2s;
    }

    .btn-ack:hover {
        background: #c7d2fe;
    }

    .btn-ack:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-ack i {
        margin-right: 5px;
    }

    .no-alerts {
        text-align: center;
        padding: 40px 20px;
        background: white;
        border-radius: 10px;
        color: #999;
        margin-bottom: 20px;
    }
</style>

<h1 class="page-title">System Alerts & Notifications</h1>

<div class="alerts-container">

    <!-- Stats Overview -->
    <div class="alerts-header">
        <div class="alert-stats">
            <div class="stat-card active">
                <div class="count">{{ active_alerts|length }}</div>
                <div class="label">Active Issues</div>
            </div>
            <div class="stat-card critical">
                <div class="count">{{ active_alerts|selectattr('severity', 'equalto', 'CRITICAL')|list|length }}</div>
                <div class="label">Critical</div>
            </div>
            <div class="stat-card warning">
                <div class="count">{{ active_alerts|selectattr('severity', 'equalto', 'WARNING')|list|length }}</div>
                <div class="label">Warnings</div>
            </div>
        </div>
    </div>

    <!-- Active Alerts Section -->
    <h3 class="section-title"><i class="fas fa-exclamation-circle"
            style="color: #e74c3c; margin-right: 10px;"></i>Active Alerts</h3>

    {% if active_alerts and active_alerts|length > 0 %}
    <table class="alerts-table">
        <thead>
            <tr>
                <th style="width: 150px;">Room</th>
                <th style="width: 100px;">Severity</th>
                <th>Message</th>
                <th style="width: 180px;">Detected At</th>
                <th style="width: 120px;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for alert in active_alerts %}
            <tr id="alert-row-{{ alert.id }}">
                <td><strong>{{ alert.room|capitalize }}</strong></td>
                <td><span class="badge badge-{{ alert.severity|lower }}">{{ alert.severity }}</span></td>
                <td>{{ alert.message }}</td>
                <td>{{ alert.updated_at|int|strftime('%H:%M:%S') }}</td>
                <td>
                    {% if not alert.is_acknowledged %}
                    <button class="btn-ack" onclick="acknowledgeAlert({{ alert.id }})">
                        <i class="fas fa-check"></i> Ack
                    </button>
                    {% else %}
                    <span style="color: #888; font-size: 0.9em;"><i class="fas fa-check-double"></i> Ack'd</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-alerts">
        <i class="fas fa-check-circle" style="font-size: 3em; color: #2ecc71; margin-bottom: 15px;"></i>
        <h3>All Systems Normal</h3>
        <p>No active alerts at this time.</p>
    </div>
    {% endif %}

    <!-- Alert History Section -->
    <h3 class="section-title"><i class="fas fa-history" style="color: #95a5a6; margin-right: 10px;"></i>Recent History
    </h3>

    {% if history and history|length > 0 %}
    <table class="alerts-table" style="opacity: 0.9;">
        <thead>
            <tr>
                <th style="width: 180px;">Timestamp</th>
                <th style="width: 120px;">Source</th>
                <th style="width: 100px;">Level</th>
                <th>Message</th>
            </tr>
        </thead>
        <tbody>
            {% for log in history %}
            <tr>
                <td>{{ log.timestamp|int|strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ log.component|capitalize }}</td>
                <td><span class="badge badge-{{ log.level|lower }}">{{ log.level }}</span></td>
                <td>{{ log.message }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-alerts">
        <p>No recent alert history.</p>
    </div>
    {% endif %}
</div>

<script>
    function acknowledgeAlert(alertId) {
        fetch(`/api/alerts/acknowledge/${alertId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Determine if we should remove the row or just mark as ack'd
                    // For now, let's reload the page to refresh stats
                    window.location.reload();
                } else {
                    alert('Failed to acknowledge alert: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while acknowledging the alert.');
            });
    }
</script>
{% endblock %}