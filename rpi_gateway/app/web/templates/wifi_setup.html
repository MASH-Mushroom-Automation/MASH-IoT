{% extends "base.html" %}
{% block title %}WiFi Setup{% endblock %}

{% block content %}
<h1 class="page-title">WiFi Configuration</h1>

<div class="content-area">
    <!-- Current Network Status -->
    {% if current_network %}
    <div class="info-card success">
        <div class="info-header">
            <i class="fas fa-check-circle"></i>
            <h3>Currently Connected</h3>
        </div>
        <div class="info-body">
            <div class="network-name">
                <i class="fas fa-wifi"></i>
                <strong>{{ current_network }}</strong>
            </div>
            <p class="info-text">Your device is connected to this network.</p>
            <button onclick="disconnectWiFi()" class="btn-danger" style="margin-top: 10px;">
                <i class="fas fa-unlink"></i> Disconnect
            </button>
        </div>
    </div>
    {% else %}
    <div class="info-card warning">
        <div class="info-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Not Connected</h3>
        </div>
        <div class="info-body">
            <p class="info-text">No WiFi connection detected. Please connect to a network below.</p>
        </div>
    </div>
    {% endif %}

    <!-- WiFi Connection Form -->
    <div class="wifi-setup-card">
        <h2><i class="fas fa-network-wired"></i> Connect to Network</h2>
        
        <form action="{{ url_for('web.wifi_connect') }}" method="post" class="wifi-form">
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-list"></i> Select Network
                </label>
                <select name="ssid_select" class="form-control" onchange="toggleManual(this)" required>
                    {% if networks and networks|length > 0 %}
                        <option value="">-- Choose a network --</option>
                        {% for net in networks %}
                            <option value="{{ net }}">{{ net }}</option>
                        {% endfor %}
                        <option value="OTHER">✏️ Enter Manually...</option>
                    {% else %}
                        <option value="OTHER">✏️ Enter Manually...</option>
                    {% endif %}
                </select>
            </div>
            
            <div class="form-group" id="manual_ssid_group" style="display: none;">
                <label class="form-label">
                    <i class="fas fa-wifi"></i> Network Name (SSID)
                </label>
                <input type="text" 
                       id="manual_ssid" 
                       name="manual_ssid" 
                       class="form-control"
                       placeholder="Enter network name...">
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-lock"></i> Password
                </label>
                <input type="password" 
                       name="password" 
                       class="form-control"
                       placeholder="Enter WiFi password" 
                       required>
            </div>
            
            <button type="submit" class="btn-primary">
                <i class="fas fa-plug"></i> Connect to Network
            </button>
        </form>
    </div>
    
    <!-- Info Section -->
    <div class="info-card info">
        <div class="info-header">
            <i class="fas fa-info-circle"></i>
            <h3>Connection Process</h3>
        </div>
        <div class="info-body">
            <ul class="info-list">
                <li><strong>Smart Switching:</strong> If connected, the device will disconnect first, then connect to the new network.</li>
                <li><strong>Automatic Fallback:</strong> If the connection fails, it will automatically reconnect to your previous network.</li>
                <li><strong>Credentials Saved:</strong> Your last successful connection is saved for easy fallback.</li>
                <li><strong>Hotspot Failsafe:</strong> If reconnection fails entirely, the provisioning hotspot will restart.</li>
                <li>Make sure you have the correct password for the network.</li>
            </ul>
        </div>
    </div>
</div>

<script>
    function toggleManual(select) {
        var manualGroup = document.getElementById("manual_ssid_group");
        var manualInput = document.getElementById("manual_ssid");
        if (select.value === "OTHER") {
            manualGroup.style.display = "block";
            manualInput.required = true;
        } else {
            manualGroup.style.display = "none";
            manualInput.required = false;
        }
    }
    
    async function disconnectWiFi() {
        if (!confirm('Are you sure you want to disconnect from WiFi?')) {
            return;
        }
        
        try {
            const response = await fetch('/wifi-disconnect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Disconnected successfully!');
                location.reload();
            } else {
                alert('Failed to disconnect: ' + result.message);
            }
        } catch (error) {
            alert('Error disconnecting: ' + error.message);
        }
    }
</script>
{% endblock %}