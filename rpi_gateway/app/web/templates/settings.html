{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<h1 class="page-title">System Settings</h1>

<div class="content-area">
    <!-- WiFi Status Card (Full Width) -->
    <div class="card" style="margin-bottom: 25px;">
        <div class="card-header">
            <i class="fas fa-wifi"></i>
            <h3>WiFi Connection</h3>
        </div>
        <div class="card-body">
            <div id="wifi-status-container" style="margin-bottom: 15px;">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading WiFi status...
                </div>
            </div>

            <div id="wifi-controls" style="display: none;">
                <button id="disconnect-btn" class="setting-button"
                    style="background: linear-gradient(135deg, #f44336, #d32f2f);">
                    <i class="fas fa-unlink"></i> Disconnect and Enable Provisioning
                </button>
            </div>
        </div>
    </div>

    <!-- About Section -->
    <div class="card" style="margin-bottom: 25px;">
        <div class="card-header">
            <i class="fas fa-info-circle"></i>
            <h3>About</h3>
        </div>
        <div class="card-body">
            <div style="background: #2c2c2c; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p style="margin: 5px 0; color: #4CAF50; font-weight: bold; font-size: 1.1em;">MASH IoT Gateway</p>
                <p style="margin: 5px 0;"><strong>Version:</strong> <span id="version"></span></p>
                <p style="margin: 5px 0;"><strong>System:</strong> Raspberry Pi</p>
                <p style="margin: 5px 0; opacity: 0.7; font-size: 0.9em;">Mushroom Automation with Smart
                    Hydro-Environment</p>
            </div>
            <button class="setting-button" onclick="showChangelog()"
                style="background: linear-gradient(135deg, #2196F3, #1976D2);">
                <i class="fas fa-list-alt"></i> View Changelog
            </button>
        </div>
    </div>

    <!-- Sync Settings -->
    <div class="card" style="margin-bottom: 25px;">
        <div class="card-header">
            <i class="fas fa-sync"></i>
            <h3>Sync Settings</h3>
        </div>
        <div class="card-body">
            <div class="toggle-row"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <strong>Firebase Realtime Sync</strong>
                    <p style="margin: 5px 0 0 0; opacity: 0.7; font-size: 0.9em;">Enable real-time sensor data
                        synchronization via Firebase</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="firebase-sync-toggle" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- Power Controls -->
    <div class="card" style="margin-top: 25px; border-color: #ff9800;">
        <div class="card-header" style="background: rgba(255, 152, 0, 0.1);">
            <i class="fas fa-power-off" style="color: #ff9800;"></i>
            <h3>Power Controls</h3>
        </div>
        <div class="card-body">
            <p style="color: #ff9800; margin-bottom: 20px;">
                <i class="fas fa-exclamation-triangle"></i>
                System operations will interrupt monitoring temporarily.
            </p>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="action-button danger" onclick="handleReboot()">
                    <i class="fas fa-sync-alt"></i> Reboot Device
                </button>
                <button class="action-button danger" onclick="handleShutdown()">
                    <i class="fas fa-power-off"></i> Shutdown Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Changelog Modal -->
<div id="changelog-modal" class="changelog-modal">
    <div class="changelog-modal-content">
        <div class="changelog-modal-header">
            <h2><i class="fas fa-history"></i> Changelog</h2>
            <span class="changelog-close" onclick="closeChangelog()">&times;</span>
        </div>
        <div class="changelog-modal-body" id="changelog-content">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading changelog...
            </div>
        </div>
    </div>
</div>

<style>
    .setting-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        text-decoration: none;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
    }

    .setting-button:hover {
        background: linear-gradient(135deg, #45a049, #3d8b40);
        transform: scale(1.02);
    }

    .action-button {
        padding: 12px 20px;
        background: #666;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .action-button:hover {
        background: #777;
        transform: scale(1.02);
    }

    .action-button.danger {
        background: linear-gradient(135deg, #f44336, #d32f2f);
    }

    .action-button.danger:hover {
        background: linear-gradient(135deg, #d32f2f, #c62828);
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #666;
        transition: 0.4s;
        border-radius: 26px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked+.toggle-slider {
        background: linear-gradient(135deg, #4CAF50, #45a049);
    }

    input:checked+.toggle-slider:before {
        transform: translateX(24px);
    }

    /* Changelog Modal */
    .changelog-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .changelog-modal-content {
        background: linear-gradient(135deg, #1e1e1e, #2d2d2d);
        margin: 5% auto;
        padding: 0;
        border: 2px solid #4CAF50;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(76, 175, 80, 0.3);
        animation: slideDown 0.3s;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .changelog-modal-header {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        padding: 20px;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .changelog-modal-header h2 {
        margin: 0;
        color: white;
        font-size: 1.5em;
    }

    .changelog-close {
        color: white;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .changelog-close:hover {
        transform: scale(1.2);
    }

    .changelog-modal-body {
        padding: 25px;
        overflow-y: auto;
        max-height: calc(80vh - 80px);
        color: #e0e0e0;
    }

    .changelog-modal-body pre {
        background: #1a1a1a;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #4CAF50;
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        line-height: 1.6;
        color: #f0f0f0;
    }

    .changelog-modal-body .loading {
        text-align: center;
        padding: 40px;
        font-size: 1.2em;
        color: #4CAF50;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .changelog-modal-content {
            width: 95%;
            margin: 10% auto;
        }

        .changelog-modal-header h2 {
            font-size: 1.2em;
        }
    }
</style>

<script>
    // Load WiFi status
    async function loadWiFiStatus() {
        try {
            const response = await fetch('/api/wifi-mode');
            const data = await response.json();

            const container = document.getElementById('wifi-status-container');
            const controls = document.getElementById('wifi-controls');

            if (!data.success) {
                container.innerHTML = '<p style="color: #f44336;">Failed to load WiFi status</p>';
                return;
            }

            if (data.mode === 'station') {
                // Connected to WiFi
                container.innerHTML = `
                <div style="background: #2c2c2c; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: #4CAF50;">Connected</span></p>
                    <p style="margin: 5px 0;"><strong>Network:</strong> ${data.ssid}</p>
                    <p style="margin: 5px 0;"><strong>IP Address:</strong> ${data.ip}</p>
                </div>
            `;
                controls.style.display = 'block';

            } else if (data.mode === 'hotspot') {
                // In provisioning mode
                container.innerHTML = `
                <div style="background: #2c2c2c; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: #ff9800;">Provisioning Mode</span></p>
                    <p style="margin: 5px 0;"><strong>Hotspot SSID:</strong> ${data.ssid}</p>
                    <p style="margin: 5px 0;"><strong>IP Address:</strong> ${data.ip}</p>
                    <p style="margin: 10px 0 0 0; color: #856404;">
                        <i class="fas fa-info-circle"></i>
                        Device is waiting for WiFi configuration.
                    </p>
                </div>
            `;
                controls.style.display = 'none';

            } else {
                // Disconnected
                container.innerHTML = `
                <div style="background: #2c2c2c; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                    <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: #f44336;">Disconnected</span></p>
                    <p style="margin: 5px 0;">No network connection</p>
                </div>
            `;
                controls.style.display = 'none';
            }

        } catch (error) {
            console.error('Error loading WiFi status:', error);
            document.getElementById('wifi-status-container').innerHTML =
                '<p style="color: #f44336;">Error loading WiFi status</p>';
        }
    }

    // Load version info
    async function loadVersionInfo() {
        try {
            const response = await fetch('/api/version');
            const data = await response.json();

            if (data.success) {
                document.getElementById('version').textContent = data.version;
            } else {
                document.getElementById('version').textContent = 'Unknown';
            }
        } catch (error) {
            console.error('Error loading version info:', error);
            document.getElementById('version').textContent = 'Error';
        }
    }

    // Disconnect from WiFi with custom modal
    function handleDisconnect() {
        showConfirm(
            'Disconnect from current network? Device will enter provisioning mode and start the hotspot.',
            async function () {
                try {
                    const response = await fetch('/wifi-disconnect', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Disconnected successfully! Device is now in provisioning mode.');
                        setTimeout(loadWiFiStatus, 2000);
                    } else {
                        showError('Failed to disconnect: ' + data.error);
                    }
                } catch (error) {
                    showError('Error disconnecting: ' + error.message);
                }
            },
            {
                title: 'Disconnect WiFi',
                icon: 'fa-unlink',
                danger: true,
                confirmText: 'Disconnect'
            }
        );
    }

    // System action handlers
    function handleReboot() {
        showConfirm(
            'Are you sure you want to reboot the device? This will temporarily interrupt monitoring.',
            async function () {
                try {
                    const response = await fetch('/api/system/reboot', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Device is rebooting... Please wait about 60 seconds.');
                    } else {
                        showError('Failed to reboot: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    showError('Error initiating reboot: ' + error.message);
                }
            },
            {
                title: 'Reboot Device',
                icon: 'fa-sync-alt',
                danger: true,
                confirmText: 'Reboot'
            }
        );
    }

    function handleShutdown() {
        showConfirm(
            'Are you sure you want to shutdown the device? You will need to manually power it back on.',
            async function () {
                try {
                    const response = await fetch('/api/system/shutdown', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Device is shutting down... Goodbye!');
                    } else {
                        showError('Failed to shutdown: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    showError('Error initiating shutdown: ' + error.message);
                }
            },
            {
                title: 'Shutdown Device',
                icon: 'fa-power-off',
                danger: true,
                confirmText: 'Shutdown'
            }
        );
    }

    // Firebase sync toggle handler
    async function handleFirebaseSyncToggle(enabled) {
        try {
            const response = await fetch('/api/firebase-sync/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled })
            });

            const data = await response.json();

            if (data.success) {
                if (enabled) {
                    showSuccess('Firebase sync enabled. All dashboards will sync in real-time.');
                } else {
                    showSuccess('Firebase sync disabled. Dashboards will show "Sync: Disabled".');
                }
            } else {
                showError('Failed to update sync preference.');
            }
        } catch (error) {
            console.error('Error toggling Firebase sync:', error);
            showError('Failed to update sync preference.');
        }
    }

    // Changelog modal functions
    async function showChangelog() {
        const modal = document.getElementById('changelog-modal');
        const content = document.getElementById('changelog-content');

        modal.style.display = 'block';

        try {
            const response = await fetch('/api/changelog?full=true');
            const data = await response.json();

            if (data.success && data.changelogs && data.changelogs.length > 0) {
                let html = '';
                data.changelogs.forEach(entry => {
                    html += `<div class="changelog-entry">`;
                    html += `<pre>${entry.content || 'No details available.'}</pre>`;
                    html += `</div>`;
                });
                content.innerHTML = html;
            } else {
                content.innerHTML = '<p style="color: #ff6b6b;">No changelog entries found.</p>';
            }
        } catch (error) {
            console.error('Error loading changelog:', error);
            content.innerHTML = '<p style="color: #ff6b6b;">Error loading changelog.</p>';
        }
    }

    function closeChangelog() {
        document.getElementById('changelog-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('changelog-modal');
        if (event.target === modal) {
            closeChangelog();
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        loadWiFiStatus();

        // Refresh every 10 seconds
        setInterval(loadWiFiStatus, 10000);

        // Disconnect button handler
        const disconnectBtn = document.getElementById('disconnect-btn');
        if (disconnectBtn) {
            disconnectBtn.addEventListener('click', handleDisconnect);
        }

        loadVersionInfo();


        // Firebase sync toggle handler
        const syncToggle = document.getElementById('firebase-sync-toggle');
        if (syncToggle) {
            // Load state from server
            fetch('/api/firebase-sync/status')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        syncToggle.checked = data.enabled;
                    }
                })
                .catch(err => console.error('Failed to load sync status:', err));

            // Handle toggle changes
            syncToggle.addEventListener('change', function () {
                handleFirebaseSyncToggle(this.checked);
            });
        }
    });
</script>

{% endblock %}