{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<h1 class="page-title">System Settings</h1>

<div class="settings-layout">
    <!-- Sidebar Navigation -->
    <div class="settings-sidebar">
        <div
            style="padding: 10px 15px 20px 15px; border-bottom: 1px solid #333; margin-bottom: 15px; text-align: center;">
            <img src="{{ url_for('web.static', filename='assets/logo-123x89.png') }}" alt="Logo"
                style="height: 40px; margin-bottom: 10px;">
            <div style="font-size: 0.85em; color: #4CAF50; font-weight: 600;">MASH GATEWAY</div>
            <div style="font-size: 0.7em; color: #666; margin-top: 4px;">SYSTEM OPERATIONAL</div>
        </div>
        <a class="settings-nav-item active" data-tab="general" onclick="switchTab('general')">
            <i class="fas fa-info-circle"></i> General
        </a>
        <a class="settings-nav-item" data-tab="wifi" onclick="switchTab('wifi')">
            <i class="fas fa-wifi"></i> WiFi Connection
        </a>
        <a class="settings-nav-item" data-tab="cloud" onclick="switchTab('cloud')">
            <i class="fas fa-sync"></i> Cloud Sync
        </a>
        <a class="settings-nav-item" data-tab="power" onclick="switchTab('power')">
            <i class="fas fa-power-off"></i> Power Controls
        </a>
        <a class="settings-nav-item" data-tab="about" onclick="switchTab('about')">
            <i class="fas fa-microchip"></i> About System
        </a>
    </div>

    <!-- Content Area -->
    <div class="settings-content">
        <!-- General Tab -->
        <div id="pane-general" class="settings-pane active">
            <h2><i class="fas fa-info-circle"></i> General Settings</h2>
            <div class="premium-card">
                <div class="premium-card-header">
                    <h3><i class="fas fa-clock"></i> System Time</h3>
                </div>
                <div class="settings-info-row">
                    <span class="settings-info-label">Local Time</span>
                    <span class="settings-info-value" id="current-time">Loading...</span>
                </div>
                <div class="settings-info-row">
                    <span class="settings-info-label">Uptime</span>
                    <span class="settings-info-value" id="system-uptime">Calculating...</span>
                </div>
            </div>
        </div>

        <!-- WiFi Tab -->
        <div id="pane-wifi" class="settings-pane">
            <h2><i class="fas fa-wifi"></i> WiFi Connection</h2>
            <div class="premium-card">
                <div class="premium-card-header">
                    <h3><i class="fas fa-network-wired"></i> Connection Status</h3>
                </div>
                <div id="wifi-status-container">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> Loading WiFi status...
                    </div>
                </div>
                <div id="wifi-controls"
                    style="display: none; margin-top: 25px; padding-top: 20px; border-top: 1px solid #3d3d3d;">
                    <button id="disconnect-btn" class="setting-button"
                        style="background: linear-gradient(135deg, #f44336, #d32f2f); max-width: 300px;">
                        <i class="fas fa-unlink"></i> Disconnect and Enable Provisioning
                    </button>
                </div>
            </div>
        </div>

        <!-- Cloud Tab -->
        <div id="pane-cloud" class="settings-pane">
            <h2><i class="fas fa-sync"></i> Cloud Sync</h2>
            <div class="premium-card">
                <div class="premium-card-header">
                    <h3><i class="fas fa-database"></i> Firebase Realtime Sync</h3>
                    <label class="toggle-switch">
                        <input type="checkbox" id="firebase-sync-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <p style="color: #bbb; line-height: 1.6;">
                    Enable real-time sensor data synchronization. When enabled, all dashboard data is pushed to Firebase
                    instantly, allowing your mobile app to receive live updates anywhere in the world.
                </p>
                <div class="settings-info-row" style="margin-top: 15px;">
                    <span class="settings-info-label">Sync Status</span>
                    <span class="settings-info-value" id="sync-status-text" style="color: #4CAF50;">Active</span>
                </div>
            </div>
        </div>

        <!-- Power Tab -->
        <div id="pane-power" class="settings-pane">
            <h2><i class="fas fa-power-off"></i> Power Controls</h2>
            <div class="premium-card" style="border-left: 4px solid #f44336;">
                <div class="premium-card-header">
                    <h3><i class="fas fa-exclamation-triangle" style="color: #f44336;"></i> Critical Actions</h3>
                </div>
                <p style="color: #aaa; margin-bottom: 25px;">
                    Perform maintenance operations on the gateway hardware. These actions will interrupt mushroom
                    environment monitoring temporarily.
                </p>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="action-button danger" onclick="handleReboot()">
                        <i class="fas fa-sync-alt"></i> Reboot Device
                    </button>
                    <button class="action-button danger" onclick="handleShutdown()">
                        <i class="fas fa-power-off"></i> Shutdown Device
                    </button>
                </div>
            </div>
        </div>

        <!-- About Tab -->
        <div id="pane-about" class="settings-pane">
            <h2><i class="fas fa-microchip"></i> About System</h2>
            <div class="premium-card">
                <div style="text-align: center; margin-bottom: 30px; padding-top: 10px;">
                    <img src="{{ url_for('web.static', filename='assets/logo-123x89.png') }}" alt="MASH IoT"
                        style="height: 80px; filter: drop-shadow(0 0 15px rgba(76, 175, 80, 0.4)); margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #4CAF50; font-size: 1.5em; letter-spacing: 1px;">MASH IoT Gateway</h3>
                    <p style="color: #888; margin-top: 5px;">Mushroom Automation Smart Home</p>
                </div>

                <div class="settings-info-row">
                    <span class="settings-info-label">Version</span>
                    <span class="settings-info-value" id="version">Loading...</span>
                </div>
                <div class="settings-info-row">
                    <span class="settings-info-label">System Hardware</span>
                    <span class="settings-info-value">Raspberry Pi</span>
                </div>
                <div class="settings-info-row">
                    <span class="settings-info-label">OS Environment</span>
                    <span class="settings-info-value">Linux (Debian)</span>
                </div>

                <div style="margin-top: 30px;">
                    <button class="setting-button" onclick="showChangelog()"
                        style="background: linear-gradient(135deg, #2196F3, #1976D2);">
                        <i class="fas fa-list-alt"></i> View Release Changelog
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Changelog Modal -->
<div id="changelog-modal" class="changelog-modal">
    <div class="changelog-modal-content">
        <div class="changelog-modal-header">
            <h2><i class="fas fa-history"></i> System Changelog</h2>
            <span class="changelog-close" onclick="closeChangelog()">&times;</span>
        </div>
        <div class="changelog-modal-body" id="changelog-content">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading changelog...
            </div>
        </div>
    </div>
</div>

<style>
    .setting-button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        text-decoration: none;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
    }

    .setting-button:hover {
        background: linear-gradient(135deg, #45a049, #3d8b40);
        transform: scale(1.02);
    }

    .action-button {
        padding: 12px 20px;
        background: #666;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .action-button:hover {
        background: #777;
        transform: scale(1.02);
    }

    .action-button.danger {
        background: linear-gradient(135deg, #f44336, #d32f2f);
    }

    .action-button.danger:hover {
        background: linear-gradient(135deg, #d32f2f, #c62828);
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #666;
        transition: 0.4s;
        border-radius: 26px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked+.toggle-slider {
        background: linear-gradient(135deg, #4CAF50, #45a049);
    }

    input:checked+.toggle-slider:before {
        transform: translateX(24px);
    }

    /* Changelog Modal */
    .changelog-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .changelog-modal-content {
        background: linear-gradient(135deg, #1e1e1e, #2d2d2d);
        margin: 5% auto;
        padding: 0;
        border: 2px solid #4CAF50;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(76, 175, 80, 0.3);
        animation: slideDown 0.3s;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .changelog-modal-header {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        padding: 20px;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .changelog-modal-header h2 {
        margin: 0;
        color: white;
        font-size: 1.5em;
    }

    .changelog-close {
        color: white;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .changelog-close:hover {
        transform: scale(1.2);
    }

    .changelog-modal-body {
        padding: 25px;
        overflow-y: auto;
        max-height: calc(80vh - 80px);
        color: #e0e0e0;
    }

    .changelog-modal-body .loading {
        text-align: center;
        padding: 40px;
        font-size: 1.2em;
        color: #4CAF50;
    }

    /* Page specific overrides if any */
    .changelog-entry {
        margin-bottom: 25px;
        border-bottom: 1px solid #333;
        padding-bottom: 20px;
    }

    .changelog-entry:last-child {
        border-bottom: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .changelog-modal-content {
            width: 95%;
            margin: 10% auto;
        }

        .changelog-modal-header h2 {
            font-size: 1.2em;
        }
    }
</style>

<script>
    // Tab switching logic
    function switchTab(tabId) {
        // Update nav items
        document.querySelectorAll('.settings-nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

        // Update panes
        document.querySelectorAll('.settings-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        document.getElementById(`pane-${tabId}`).classList.add('active');
    }

    // Load WiFi status
    async function loadWiFiStatus() {
        try {
            const response = await fetch('/api/wifi-mode');
            const data = await response.json();

            const container = document.getElementById('wifi-status-container');
            const controls = document.getElementById('wifi-controls');

            if (!data.success) {
                container.innerHTML = '<p style="color: #f44336; padding: 10px;">Failed to load WiFi status</p>';
                return;
            }

            if (data.mode === 'station') {
                container.innerHTML = `
                <div class="settings-info-row">
                    <span class="settings-info-label">Status</span>
                    <span class="settings-info-value" style="color: #4CAF50;">Connected</span>
                </div>
                <div class="settings-info-row">
                    <span class="settings-info-label">Network SSID</span>
                    <span class="settings-info-value">${data.ssid}</span>
                </div>
                <div class="settings-info-row">
                    <span class="settings-info-label">IP Address</span>
                    <span class="settings-info-value">${data.ip}</span>
                </div>
            `;
                controls.style.display = 'block';

            } else if (data.mode === 'hotspot') {
                container.innerHTML = `
                <div class="settings-info-row">
                    <span class="settings-info-label">Status</span>
                    <span class="settings-info-value" style="color: #ff9800;">Provisioning Mode</span>
                </div>
                <div class="settings-info-row">
                    <span class="settings-info-label">Hotspot SSID</span>
                    <span class="settings-info-value">${data.ssid}</span>
                </div>
                <div class="settings-info-row">
                    <span class="settings-info-label">Hotspot IP</span>
                    <span class="settings-info-value">${data.ip}</span>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: rgba(255, 152, 0, 0.1); border-radius: 8px; color: #ff9800;">
                    <i class="fas fa-info-circle"></i>
                    Device is broadcasting its own network for configuration.
                </div>
            `;
                controls.style.display = 'none';

            } else {
                container.innerHTML = `
                <div class="settings-info-row">
                    <span class="settings-info-label">Status</span>
                    <span class="settings-info-value" style="color: #f44336;">Disconnected</span>
                </div>
                <p style="color: #888; margin-top: 10px;">No network connection established.</p>
            `;
                controls.style.display = 'none';
            }

        } catch (error) {
            console.error('Error loading WiFi status:', error);
            document.getElementById('wifi-status-container').innerHTML =
                '<p style="color: #f44336;">Error loading WiFi status</p>';
        }
    }

    // Load version info
    async function loadVersionInfo() {
        try {
            const response = await fetch('/api/version');
            const data = await response.json();

            if (data.success) {
                document.getElementById('version').textContent = data.version;
            } else {
                document.getElementById('version').textContent = 'Unknown';
            }
        } catch (error) {
            console.error('Error loading version info:', error);
            document.getElementById('version').textContent = 'Error';
        }
    }

    // System info helpers
    function updateSystemInfo() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleString();
        document.getElementById('system-uptime').textContent = "Running (MASH 2.0 Engine)";
    }

    // Disconnect from WiFi with custom modal
    function handleDisconnect() {
        showConfirm(
            'Disconnect from current network? Device will enter provisioning mode and start the hotspot.',
            async function () {
                try {
                    const response = await fetch('/wifi-disconnect', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Disconnected successfully! Device is now in provisioning mode.');
                        setTimeout(loadWiFiStatus, 2000);
                    } else {
                        showError('Failed to disconnect: ' + data.error);
                    }
                } catch (error) {
                    showError('Error disconnecting: ' + error.message);
                }
            },
            {
                title: 'Disconnect WiFi',
                icon: 'fa-unlink',
                danger: true,
                confirmText: 'Disconnect'
            }
        );
    }

    // System action handlers
    function handleReboot() {
        showConfirm(
            'Are you sure you want to reboot the device? This will temporarily interrupt monitoring.',
            async function () {
                try {
                    const response = await fetch('/api/system/reboot', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Device is rebooting... Please wait about 60 seconds.');
                    } else {
                        showError('Failed to reboot: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    showError('Error initiating reboot: ' + error.message);
                }
            },
            {
                title: 'Reboot Device',
                icon: 'fa-sync-alt',
                danger: true,
                confirmText: 'Reboot'
            }
        );
    }

    function handleShutdown() {
        showConfirm(
            'Are you sure you want to shutdown the device? You will need to manually power it back on.',
            async function () {
                try {
                    const response = await fetch('/api/system/shutdown', { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        showSuccess('Device is shutting down... Goodbye!');
                    } else {
                        showError('Failed to shutdown: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    showError('Error initiating shutdown: ' + error.message);
                }
            },
            {
                title: 'Shutdown Device',
                icon: 'fa-power-off',
                danger: true,
                confirmText: 'Shutdown'
            }
        );
    }

    // Firebase sync toggle handler
    async function handleFirebaseSyncToggle(enabled) {
        const statusText = document.getElementById('sync-status-text');
        try {
            const response = await fetch('/api/firebase-sync/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled })
            });

            const data = await response.json();

            if (data.success) {
                if (enabled) {
                    showSuccess('Firebase sync enabled. All dashboards will sync in real-time.');
                    statusText.textContent = 'Active';
                    statusText.style.color = '#4CAF50';
                } else {
                    showSuccess('Firebase sync disabled.');
                    statusText.textContent = 'Disabled';
                    statusText.style.color = '#999';
                }
            } else {
                showError('Failed to update sync preference.');
            }
        } catch (error) {
            console.error('Error toggling Firebase sync:', error);
            showError('Failed to update sync preference.');
        }
    }

    // Changelog modal functions
    async function showChangelog() {
        const modal = document.getElementById('changelog-modal');
        const content = document.getElementById('changelog-content');

        modal.style.display = 'block';

        try {
            const response = await fetch('/api/changelog?full=true');
            const data = await response.json();

            if (data.success && data.changelogs && data.changelogs.length > 0) {
                let html = '';
                data.changelogs.forEach(entry => {
                    html += `<div class="changelog-entry">`;
                    html += `<h4 style="color: #4CAF50; margin: 0 0 10px 0;">Version ${entry.version} (${entry.date})</h4>`;
                    html += `<pre style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50; white-space: pre-wrap; font-family: monospace; color: #eee; line-height: 1.5;">${entry.content || 'No details available.'}</pre>`;
                    html += `</div>`;
                });
                content.innerHTML = html;
            } else {
                content.innerHTML = '<p style="color: #ff6b6b;">No changelog entries found.</p>';
            }
        } catch (error) {
            console.error('Error loading changelog:', error);
            content.innerHTML = '<p style="color: #ff6b6b;">Error loading changelog.</p>';
        }
    }

    function closeChangelog() {
        document.getElementById('changelog-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('changelog-modal');
        if (event.target === modal) {
            closeChangelog();
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        loadWiFiStatus();
        updateSystemInfo();
        loadVersionInfo();

        // Refresh every 10 seconds for Wifi & Time
        setInterval(loadWiFiStatus, 10000);
        setInterval(updateSystemInfo, 1000);

        // Disconnect button handler
        const disconnectBtn = document.getElementById('disconnect-btn');
        if (disconnectBtn) {
            disconnectBtn.addEventListener('click', handleDisconnect);
        }

        // Firebase sync toggle handler
        const syncToggle = document.getElementById('firebase-sync-toggle');
        const syncStatusText = document.getElementById('sync-status-text');

        if (syncToggle) {
            // Load state from server
            fetch('/api/firebase-sync/status')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        syncToggle.checked = data.enabled;
                        syncStatusText.textContent = data.enabled ? 'Active' : 'Disabled';
                        syncStatusText.style.color = data.enabled ? '#4CAF50' : '#999';
                    }
                })
                .catch(err => console.error('Failed to load sync status:', err));

            // Handle toggle changes
            syncToggle.addEventListener('change', function () {
                handleFirebaseSyncToggle(this.checked);
            });
        }
    });
</script>

{% endblock %}