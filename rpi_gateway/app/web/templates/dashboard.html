{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="system-info-bar">
    <div class="view-toggle">
        <button id="show-fruiting" class="toggle-btn active">Fruiting Room</button>
        <button id="show-spawning" class="toggle-btn">Spawning Room</button>
    </div>
    <div class="system-status">
        <span><i class="fas fa-microchip"></i> Sensors: <span id="arduino-status"
                class="{% if arduino_connected %}status-ok{% else %}status-error{% endif %}">{% if arduino_connected
                %}Connected{% else %}Offline{% endif %}</span></span>
        |
        <span><i class="fas fa-wifi"></i> WiFi: <span id="wifi-status" class="status-warning">Checking...</span></span>
        |
        <span><i class="fas fa-sync"></i> Sync: <span id="sync-status"
                class="status-warning">Connecting...</span></span>
        |
        <span><i class="fas fa-clock"></i> Uptime: <span id="uptime">--</span></span>
    </div>
</div>


<!-- Provisioning Status Banner (Visible only in Hotspot Mode) -->
<div id="provisioning-banner" onclick="openWifiModal()"
    style="display: none; background: #ff9800; color: #000; padding: 20px; text-align: center; margin-bottom: 25px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">
        <i class="fas fa-exclamation-triangle"></i> Device is in Provisioning Mode
    </div>
    <div style="font-size: 1em; opacity: 0.9;">
        Hotspot <strong style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px;">MASH-Device</strong>
        is active
    </div>
    <div
        style="margin-top: 15px; display: inline-block; background: #000; color: #ff9800; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 0.9em;">
        <i class="fas fa-fingerprint"></i> Tap to Configure WiFi
    </div>
</div>


<!-- WiFi Setup Modal -->
<div id="wifiSetupModal" class="custom-modal" style="display: none;">
    <div class="custom-modal-content" style="max-width: 480px;">
        <div class="custom-modal-header">
            <i class="fas fa-wifi"></i>
            <h3>WiFi Setup Guide</h3>
            <span class="close-modal" onclick="closeWifiModal()"
                style="margin-left: auto; cursor: pointer; font-size: 1.5rem;">&times;</span>
        </div>
        <div class="custom-modal-body" style="text-align: center; padding: 15px;">

            <!-- Step 1 -->
            <div id="modal-step-1">
                <h4 style="color: #4CAF50; margin-top: 0; margin-bottom: 12px; font-size: 1.1em;">Step 1: Connect to
                    Hotspot</h4>
                <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0 0 10px 0; font-size: 0.95em;">On your mobile or laptop, connect to the WiFi
                        network:</p>
                    <div
                        style="background: #000; padding: 12px; border-radius: 6px; display: inline-block; margin: 10px 0; border: 1px solid #333;">
                        <code style="color: #4CAF50; font-size: 1.2em; font-weight: bold;">MASH-Device</code>
                    </div>
                    <p style="font-size: 0.85em; color: #888; margin: 0;">(No password required)</p>
                </div>
                <button onclick="nextStep()" class="btn-primary"
                    style="width: 100%; padding: 10px; font-weight: bold; font-size: 0.95em;">
                    Next <i class="fas fa-arrow-right" style="margin-left: 5px;"></i>
                </button>
            </div>

            <!-- Step 2 -->
            <div id="modal-step-2" style="display: none;">
                <h4 style="color: #4CAF50; margin-top: 0; margin-bottom: 12px; font-size: 1.1em;">Step 2: Configure
                    Settings</h4>
                <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0 0 10px 0; font-size: 0.95em;">Scan this code to open the setup page:</p>

                    <div id="qr-code-container"
                        style="margin: 8px auto; background: white; padding: 8px; display: inline-block; border-radius: 8px;">
                        <img id="qr-code-image" src="" alt="Loading QR..."
                            style="max-width: 150px; width: 100%; display: block;">
                    </div>

                    <div style="margin-top: 12px;">
                        <p style="margin: 0 0 6px 0; font-size: 0.95em;">Or open this URL in your browser:</p>
                        <p style="font-size: 0.75em; color: #888; margin: 8px 0 0 0;">http://mash.lan/wifi-setup</p>
                    </div>
                </div>
                <button onclick="prevStep()" class="btn-primary"
                    style="background: #333; width: 100%; padding: 10px; font-weight: bold; font-size: 0.95em;">
                    <i class="fas fa-arrow-left" style="margin-right: 5px;"></i> Back
                </button>
            </div>

        </div>
    </div>
</div>


<div id="fruiting-view" class="room-view">
    <div class="room-header">
        <h2 class="room-title">Fruiting Room</h2>
        <div class="room-condition">Condition: <span class="status-{{ fruiting_condition_class }}">{{ fruiting_condition
                }}</span></div>
    </div>

    <div class="sensor-grid">
        <div class="sensor-card co2">
            <div class="card-header">
                <i class="fas fa-wind"></i>
                <h3>CO2 Level</h3>
            </div>
            <div class="card-body">
                <span id="fruiting-co2" class="sensor-value">{% if fruiting_data and fruiting_data.co2 is not none %}{{
                    fruiting_data.co2 | int }}{% else %}--{% endif %}</span>
                <span class="sensor-unit">ppm</span>
            </div>
            <div class="card-footer">
                <span>Target: < {{ fruiting_targets.co2_max }} ppm</span>
            </div>
        </div>
        <div class="sensor-card temp">
            <div class="card-header">
                <i class="fas fa-thermometer-half"></i>
                <h3>Temperature</h3>
            </div>
            <div class="card-body">
                <span id="fruiting-temp" class="sensor-value">{% if fruiting_data and fruiting_data.temp is not none
                    %}{{ fruiting_data.temp | round(1) }}{% else %}--{% endif %}</span>
                <span class="sensor-unit">°C</span>
            </div>
            <div class="card-footer">
                <span>Target: {{ fruiting_targets.temp_target }}°C</span>
            </div>
        </div>
        <div class="sensor-card humidity">
            <div class="card-header">
                <i class="fas fa-water"></i>
                <h3>Humidity</h3>
            </div>
            <div class="card-body">
                <span id="fruiting-humidity" class="sensor-value">{% if fruiting_data and fruiting_data.humidity is not
                    none %}{{ fruiting_data.humidity | round(1) }}{% else %}--{% endif %}</span>
                <span class="sensor-unit">%</span>
            </div>
            <div class="card-footer">
                <span>Target: {{ fruiting_targets.humidity_target }}%</span>
            </div>
        </div>
    </div>
</div>

<div id="spawning-view" class="room-view" style="display: none;">
    <div class="room-header">
        <h2 class="room-title">Spawning Room</h2>
        <div class="room-condition">Condition: <span class="status-{{ spawning_condition_class }}">{{ spawning_condition
                }}</span></div>
    </div>

    <div class="sensor-grid">
        <div class="sensor-card co2">
            <div class="card-header">
                <i class="fas fa-wind"></i>
                <h3>CO2 Level</h3>
            </div>
            <div class="card-body">
                <span id="spawning-co2" class="sensor-value">{% if spawning_data and spawning_data.co2 is not none %}{{
                    spawning_data.co2 | int }}{% else %}--{% endif %}</span>
                <span class="sensor-unit">ppm</span>
            </div>
            <div class="card-footer">
                <span>Target: < {{ spawning_targets.co2_max }} ppm</span>
            </div>
        </div>
        <div class="sensor-card temp">
            <div class="card-header">
                <i class="fas fa-thermometer-half"></i>
                <h3>Temperature</h3>
            </div>
            <div class="card-body">
                <span id="spawning-temp" class="sensor-value">{% if spawning_data and spawning_data.temp is not none
                    %}{{ spawning_data.temp | round(1) }}{% else %}--{% endif %}</span>
                <span class="sensor-unit">°C</span>
            </div>
            <div class="card-footer">
                <span>Target: {{ spawning_targets.temp_target }}°C</span>
            </div>
        </div>
        <div class="sensor-card humidity">
            <div class="card-header">
                <i class="fas fa-water"></i>
                <h3>Humidity</h3>
            </div>
            <div class="card-body">
                <span id="spawning-humidity" class="sensor-value">{% if spawning_data and spawning_data.humidity is not
                    none %}{{ spawning_data.humidity | round(1) }}{% else %}--{% endif %}</span>
                <span class="sensor-unit">%</span>
            </div>
            <div class="card-footer">
                <span>Target: {{ spawning_targets.humidity_target }}%</span>
            </div>
        </div>
    </div>
</div>

<script>
    // Modal Functions
    function openWifiModal() {
        document.getElementById('wifiSetupModal').style.display = 'flex';
        // Reset to step 1
        document.getElementById('modal-step-1').style.display = 'block';
        document.getElementById('modal-step-2').style.display = 'none';
    }

    function nextStep() {
        document.getElementById('modal-step-1').style.display = 'none';
        document.getElementById('modal-step-2').style.display = 'block';
    }

    function prevStep() {
        document.getElementById('modal-step-2').style.display = 'none';
        document.getElementById('modal-step-1').style.display = 'block';
    }

    function closeWifiModal() {
        document.getElementById('wifiSetupModal').style.display = 'none';
    }

    // Close modal if clicked outside
    window.onclick = function (event) {
        const modal = document.getElementById('wifiSetupModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Check WiFi mode and display Provisioning Banner if in hotspot mode
    async function checkProvisioningMode() {
        try {
            const response = await fetch('/api/wifi-mode');
            const data = await response.json();

            if (data.success && data.mode === 'hotspot') {
                // Device is in provisioning mode - show Banner and Load QR
                document.getElementById('provisioning-banner').style.display = 'block';

                // Fetch and display QR code (target URL for web setup)
                const qrResponse = await fetch('/api/wifi-qr');
                const qrData = await qrResponse.json();

                if (qrData.success) {
                    document.getElementById('qr-code-image').src = qrData.qr_code;
                }
            } else {
                // Connected to network - hide banner
                document.getElementById('provisioning-banner').style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking provisioning mode:', error);
        }
    }

    // Check provisioning mode on page load and every 10 seconds
    document.addEventListener('DOMContentLoaded', function () {
        checkProvisioningMode();
        setInterval(checkProvisioningMode, 10000);
    });

    // === FIREBASE REALTIME LISTENER ===
    document.addEventListener('DOMContentLoaded', function () {
        const syncStatusEl = document.getElementById('sync-status');

        // Check if Firebase sync is enabled (server-side preference) using promises
        fetch('/api/firebase-sync/status')
            .then(res => res.json())
            .then(syncData => {
                if (!syncData.enabled) {
                    if (syncStatusEl) {
                        syncStatusEl.textContent = 'Disabled';
                        syncStatusEl.className = 'status-warning';
                    }
                    console.log('[FIREBASE] Sync disabled by server preference');
                    return; // Stop here if disabled
                }

                // Continue with Firebase init if enabled
                initializeFirebase();
            })
            .catch(error => {
                console.error('[FIREBASE] Failed to check sync status, defaulting to enabled:', error);
                // Default to enabled if check fails
                initializeFirebase();
            });

        function initializeFirebase() {

            const firebaseConfig = {
                apiKey: "AIzaSyDkJu5WB5dyWOCIZHVySuCPuoeeCF-qLmI",
                authDomain: "mash-ddf8d.firebaseapp.com",
                databaseURL: "https://mash-ddf8d-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "mash-ddf8d",
                storageBucket: "mash-ddf8d.firebasestorage.app",
                messagingSenderId: "784415877696",
                appId: "1:784415877696:web:a750bdc3d72e5a36da4da5",
                measurementId: "G-HLS3NBQG3Z"
            };

            try {
                firebase.initializeApp(firebaseConfig);
                const db = firebase.database();

                // Get device ID from template (we'll pass it from Flask)
                const deviceId = "{{ device_id }}";   // ← Will be injected by Flask

                // Reference to the latest reading path (exactly what main.py writes)
                const latestRef = db.ref(`devices/${deviceId}/latest_reading`);

                latestRef.on('value', (snapshot) => {
                    const data = snapshot.val();

                    // Update sync status to Online on first successful connection
                    if (syncStatusEl && syncStatusEl.textContent !== 'Online') {
                        syncStatusEl.textContent = 'Online';
                        syncStatusEl.className = 'status-ok';
                    }

                    if (!data) return;

                    console.log("Firebase realtime update:", data);

                    // Fruiting
                    if (data.fruiting) {
                        const fTemp = document.getElementById('fruiting-temp');
                        const fHum = document.getElementById('fruiting-humidity');
                        const fCo2 = document.getElementById('fruiting-co2');

                        if (fTemp) fTemp.textContent = data.fruiting.temperature?.toFixed(1) || '--';
                        if (fHum) fHum.textContent = data.fruiting.humidity?.toFixed(1) || '--';
                        if (fCo2) fCo2.textContent = data.fruiting.co2 || '--';
                    }

                    // Spawning
                    if (data.spawning) {
                        const sTemp = document.getElementById('spawning-temp');
                        const sHum = document.getElementById('spawning-humidity');
                        const sCo2 = document.getElementById('spawning-co2');

                        if (sTemp) sTemp.textContent = data.spawning.temperature?.toFixed(1) || '--';
                        if (sHum) sHum.textContent = data.spawning.humidity?.toFixed(1) || '--';
                        if (sCo2) sCo2.textContent = data.spawning.co2 || '--';
                    }

                    // Optional: Update room condition badges too (you can expand this)
                });

                // Handle connection errors
                latestRef.on('value', () => { }, (error) => {
                    console.error("Firebase connection error:", error);
                    if (syncStatusEl) {
                        syncStatusEl.textContent = 'Offline';
                        syncStatusEl.className = 'status-error';
                    }
                });

            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                if (syncStatusEl) {
                    syncStatusEl.textContent = 'Failed';
                    syncStatusEl.className = 'status-error';
                }
            }
        } // End initializeFirebase
    });
</script>

{% endblock %}