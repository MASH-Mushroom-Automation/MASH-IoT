# M.A.S.H. IoT - Utility Scripts

## Arduino Connection Scripts

### `find_arduino.py`
Auto-detects Arduino USB port on Raspberry Pi.

**Usage:**
```bash
python3 scripts/find_arduino.py
```

**Output:**
- Lists all serial ports
- Identifies Arduino devices
- Shows VID/PID and hardware IDs
- Recommends port to use in configuration

### `test_arduino.py`
Tests Arduino connection, data reception, and auto-reconnect feature.

**Usage:**
```bash
python3 scripts/test_arduino.py
```

**Features:**
- Auto-detects Arduino port
- Tests auto-reconnect (try unplugging/replugging Arduino)
- Displays live sensor data from both rooms
- Shows connection status changes immediately
- Press Ctrl+C to stop

**Example Output:**
```
[Packet #1] Received at 14:32:05
----------------------------------------
üçÑ Fruiting Room:
   Temperature: 23.5¬∞C
   Humidity:    85.0%
   CO2:         800 ppm

üå± Spawning Room:
   Temperature: 24.0¬∞C
   Humidity:    90.0%
   CO2:         1200 ppm
----------------------------------------

üü¢ CONNECTED - Arduino is online

[Status Check] üü¢ CONNECTED | Packets received: 5
```

### `diagnose_connection.py`
**NEW!** Monitors connection health and tests auto-reconnect in detail.

**Usage:**
```bash
python3 scripts/diagnose_connection.py
```

**Features:**
- Continuous connection monitoring (every second)
- Measures downtime when disconnected
- Counts reconnection attempts
- Shows detailed timing of reconnections
- Provides diagnostic summary at exit

**Example Output:**
```
[14:32:05] ‚úì Online | Packets: 42

üî¥ DISCONNECTED (#1)
   Auto-reconnect is active - will retry every 5 seconds

[14:32:10] ‚úó Offline | Downtime: 5s | Retrying...
[14:32:15] ‚úó Offline | Downtime: 10s | Retrying...

üü¢ RECONNECTED after 12.3 seconds

[14:32:17] ‚úì Online | Packets: 45
```

**When to use:**
- Testing auto-reconnect reliability
- Measuring reconnection speed
- Debugging connection issues
- Verifying USB cable quality

## Kiosk Mode Scripts

### `setup_kiosk.sh`
Configures Raspberry Pi to boot directly to M.A.S.H. dashboard in fullscreen kiosk mode.

**Features:**
- ‚úÖ Boots directly to browser (NO desktop environment)
- ‚úÖ Auto-starts M.A.S.H. backend on boot
- ‚úÖ Hides cursor, disables screen blanking
- ‚úÖ Faster boot (skips desktop loading)

**Usage:**
```bash
# Run as normal user (NOT sudo)
bash scripts/setup_kiosk.sh

# Then reboot
sudo reboot
```

**What it does:**
1. Creates systemd service for M.A.S.H. backend
2. Creates systemd service for kiosk mode
3. Configures auto-login to console
4. Disables unnecessary services
5. Auto-starts X server + Chromium in kiosk mode

**To exit kiosk mode:** Press `Alt+F4`

**Manual control:**
```bash
# Start/stop backend
sudo systemctl start mash-iot
sudo systemctl stop mash-iot
sudo systemctl status mash-iot

# Start/stop kiosk
sudo systemctl start mash-kiosk
sudo systemctl stop mash-kiosk

# View logs
journalctl -u mash-iot -f
journalctl -u mash-kiosk -f
```

### `run_kiosk_x.sh`
**Auto-generated by setup_kiosk.sh**. X session script that launches Chromium without desktop.

## Installation Scripts

### `install_dependencies.sh`
Installs all required system packages and Python dependencies.

**Usage:**
```bash
bash scripts/install_dependencies.sh
```

## Arduino USB Port Information

On Raspberry Pi, Arduino typically appears as:
- **`/dev/ttyACM0`** - Arduino Uno, Mega (native USB)
- **`/dev/ttyUSB0`** - Arduino with CH340/FTDI chip

The `ArduinoSerialComm` class **auto-detects** the port by default:

```python
# Auto-detection (recommended)
arduino = ArduinoSerialComm(auto_reconnect=True)
arduino.connect(auto_detect=True)

# Manual port specification
arduino = ArduinoSerialComm(port='/dev/ttyACM0')
arduino.connect(auto_detect=False)
```

## Troubleshooting

### "No Arduino found"
1. Run `python3 scripts/find_arduino.py` to scan ports
2. Check Arduino is powered on (LED should be lit)
3. Try different USB cable (some are power-only)
4. Check permissions: `sudo usermod -a -G dialout $USER` then logout/login

### "Permission denied: /dev/ttyACM0"
```bash
# Add user to dialout group
sudo usermod -a -G dialout $USER

# Logout and login again, or reboot
sudo reboot
```

### Kiosk mode not starting
```bash
# Check backend status
sudo systemctl status mash-iot

# Check kiosk status
sudo systemctl status mash-kiosk

# View logs
journalctl -u mash-iot -n 50
journalctl -u mash-kiosk -n 50
```

### Backend not accessible
```bash
# Check if Flask is running
curl http://localhost:5000

# Check firewall (if using WiFi)
sudo ufw allow 5000
```

## Quick Start Workflow

1. **Find Arduino port:**
   ```bash
   python3 scripts/find_arduino.py
   ```

2. **Test connection:**
   ```bash
   python3 scripts/test_arduino.py
   ```

3. **Setup kiosk mode:**
   ```bash
   bash scripts/setup_kiosk.sh
   sudo reboot
   ```

4. **Monitor system:**
   ```bash
   # Backend logs
   journalctl -u mash-iot -f
   
   # Arduino connection in logs
   journalctl -u mash-iot -f | grep SERIAL
   ```
